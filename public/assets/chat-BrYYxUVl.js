function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/friend-DvVXwjXP.js","assets/index-CvA2DDGm.js","assets/index-OAsUietV.css","assets/index-Dti_npMt.js","assets/_plugin-vue_export-helper-DlAUqK2U.js","assets/friend-C713QwsZ.css","assets/group-B-viPtjA.js","assets/group-J-tUKJFZ.css","assets/talk-CDUqJlNe.js","assets/talk-DE4NHLmI.css","assets/msg-CR1KuRn_.js","assets/msg-BypoleRR.css","assets/person-W76vTupI.js","assets/person-_JsV9yuj.css","assets/user-BLzQF1Az.js","assets/user-COHaruEj.css","assets/group-7WvE5RZM.js","assets/group-Dl2D1U2w.css"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
import{e as B,i as ne,m as se,u as re,c as l,a as ae,s as Re,b as Ee,d as je,f as Be,r as w,g as Le,o as Ve,h as qe,S as H,n as Y,j as R,k as $e,w as b,l as We,p as E,q as _,v as k,t as T,x as ze,y as U,z as x,A as J,B as j,C as K,D as P,E as Z,F as ee,_ as S}from"./index-CvA2DDGm.js";import{g as He,d as Ke,q as Je}from"./index-Dti_npMt.js";let Q;const Qe={title:"",width:"",theme:null,message:"",overlay:!0,callback:null,teleport:"body",className:"",allowHtml:!1,lockScroll:!0,transition:void 0,beforeClose:null,overlayClass:"",overlayStyle:void 0,messageAlign:"",cancelButtonText:"",cancelButtonColor:null,cancelButtonDisabled:!1,confirmButtonText:"",confirmButtonColor:null,confirmButtonDisabled:!1,showConfirmButton:!0,showCancelButton:!1,closeOnPopstate:!0,closeOnClickOverlay:!1};let Xe=B({},Qe);function Ye(){({instance:Q}=se({setup(){const{state:o,toggle:r}=re();return()=>l(Re,ae(o,{"onUpdate:show":r}),null)}}))}function Ze(t){return ne?new Promise((o,r)=>{Q||Ye(),Q.open(B({},Xe,t,{callback:a=>{(a==="confirm"?o:r)(a)}}))}):Promise.resolve(void 0)}const oe=t=>Ze(B({showCancelButton:!0},t));let te,A;const eo=t=>Ee(t)?t:{message:t};function oo(){({instance:A}=se({setup(){const{state:t,toggle:o}=re();return()=>l(je,ae(t,{"onUpdate:show":o}),null)}}))}const to=()=>({type:"danger",color:void 0,message:"",onClose:void 0,onClick:void 0,onOpened:void 0,duration:3e3,position:void 0,className:"",lockScroll:!1,background:void 0});let no=to();const so=()=>{A&&A.toggle(!1)};function ro(t){if(ne)return A||oo(),t=B({},no,eo(t)),A.open(t),clearTimeout(te),t.duration>0&&(te=setTimeout(so,t.duration)),A}async function ao(t,o,r){return new Promise((a,u)=>{const p=window.indexedDB.open(t,o);p.onerror=g=>{u(g.target.error)},p.onsuccess=g=>{const c=g.target.result;a(c)},p.onupgradeneeded=g=>{const c=g.target.result;for(const i of r){const m=c.createObjectStore(i.name,{keyPath:i.keyPath,autoIncrement:!0});if(i.indexes)for(const d of i.indexes)m.createIndex(d.name,d.keyPath,d.options)}}})}async function L(t,o,r){return new Promise((a,u)=>{const c=t.transaction([o],"readwrite").objectStore(o).add(r);c.onsuccess=i=>{a(i.target.result)},c.onerror=i=>{u(i.target.error)}})}async function V(t,o,r,a){return new Promise((u,p)=>{const c=t.transaction([o],"readwrite").objectStore(o),i=c.get(r);i.onsuccess=m=>{const d=m.target.result;if(d){for(const f in a)Object.prototype.hasOwnProperty.call(a,f)&&(d[f]=a[f]);const h=c.put(d);h.onsuccess=()=>{u()},h.onerror=f=>{p(f.target.error)}}else p(new Error("Record not found"))},i.onerror=m=>{p(m.target.error)}})}async function ce(t,o,r){return new Promise((a,u)=>{const c=t.transaction([o],"readwrite").objectStore(o).delete(r);c.onsuccess=()=>{a()},c.onerror=i=>{u(i.target.error)}})}async function vo(t,o,r){return new Promise((a,u)=>{const g=t.transaction([o],"readwrite").objectStore(o);let c;const i=IDBKeyRange.only(r[0].value);c=g.index(r[0].indexName).openCursor(i),c.onsuccess=d=>{const h=d.target.result;if(h){let f=!0;for(const{indexName:I,value:v}of r.slice(1))if(h.value[I]!==v){f=!1;break}if(f){const I=h.delete();I.onsuccess=()=>{h.continue()},I.onerror=v=>{u(v.target.error)}}else h.continue()}else a()},c.onerror=d=>{u(d.target.error)}})}async function M(t,o,r){return new Promise((a,u)=>{const c=t.transaction([o],"readonly").objectStore(o).get(r);c.onsuccess=i=>{a(i.target.result)},c.onerror=i=>{u(i.target.error)}})}async function co(t,o,r,a){return new Promise((u,p)=>{const m=t.transaction([o],"readonly").objectStore(o).index(r).getAll(a);m.onsuccess=d=>{u(d.target.result)},m.onerror=d=>{p(d.target.error)}})}async function Io(t,o,r,a,u){return console.log("getByTimeIndex",t,o,r,a,u),new Promise((p,g)=>{const m=t.transaction([o],"readonly").objectStore(o).index(r),d=IDBKeyRange.bound(a,u,!0,!0),h=m.getAll(d);h.onsuccess=f=>{p(f.target.result)},h.onerror=f=>{g(f.target.error)}})}async function ie(t,o){await M(t,"users",o.Uid)?await V(t,"users",o.Uid,{Uid:o.Uid,Username:o.Username,Avatar:o.Avatar,IsOnline:o.IsOnline}):await L(t,"users",{Uid:o.Uid,Username:o.Username,Avatar:o.Avatar,IsOnline:o.IsOnline})}async function wo(t,o){await M(t,"groups",o.GroupId)?await V(t,"groups",o.GroupId,{GroupId:o.GroupId,OwnerUid:o.OwnerUid,Name:o.Name,Icon:o.Icon,Info:o.Info,Num:o.Num}):await L(t,"groups",{GroupId:o.GroupId,OwnerUid:o.OwnerUid,Name:o.Name,Icon:o.Icon,Info:o.Info,Num:o.Num})}async function _o(t,o){await ce(t,"group_members",o)}async function io(t,o,r){const a=`${o}_${r.Uid}`,u=await M(t,"group_members",a);console.log("saveGroupUser",u),u?await V(t,"group_members",a,{GroupId:o,MemberId:r.Uid}):await L(t,"group_members",{GroupId:o,MemberId:r.Uid}),ie(t,r)}async function ko(t,o,r){const a=`${o}_${r}`;await ce(t,"group_members",a)}async function To(t,o){await M(t,"apply",o.Id)?await V(t,"apply",o.Id,{Id:o.Id,FromId:o.FromId,FromName:o.FromName,FromIcon:o.FromIcon,ToId:o.ToId,ToName:o.ToName,ToIcon:o.ToIcon,Type:o.Type,Status:o.Status,Reason:o.Reason,OperateTime:o.OperateTime}):await L(t,"apply",{Id:o.Id,FromId:o.FromId,FromName:o.FromName,FromIcon:o.FromIcon,ToId:o.ToId,ToName:o.ToName,ToIcon:o.ToIcon,Type:o.Type,Status:o.Status,Reason:o.Reason,OperateTime:o.OperateTime})}function O(t,o){if(Object.keys(o).length){let r=!1;return o.map(a=>{a==t&&(r=!0)}),r}else return!1}const lo=["innerHTML"],uo={key:1},po={class:"bar-text"},mo={key:2},fo={class:"bar-text"},go=J("span",null,"返回",-1),yo=Be({__name:"chat",setup(t){const o=ze(),r=P(()=>S(()=>import("./friend-DvVXwjXP.js"),__vite__mapDeps([0,1,2,3,4,5]))),a=P(()=>S(()=>import("./group-B-viPtjA.js"),__vite__mapDeps([6,1,2,3,4,7]))),u=P(()=>S(()=>import("./talk-CDUqJlNe.js"),__vite__mapDeps([8,1,2,3,4,9]))),p=P(()=>S(()=>import("./msg-CR1KuRn_.js"),__vite__mapDeps([10,1,2,3,4,11]))),g=P(()=>S(()=>import("./person-W76vTupI.js"),__vite__mapDeps([12,1,2,3,4,13]))),c=P(()=>S(()=>import("./user-BLzQF1Az.js"),__vite__mapDeps([14,1,2,3,4,15]))),i=P(()=>S(()=>import("./group-7WvE5RZM.js"),__vite__mapDeps([16,1,2,3,4,17]))),m=w(),d=w(),h=w(),f=w(),I=w(0),v=w(0),q=w(!0),e=Le({socket:null,db:null,title:"联系人",tabActiveName:"friend",selftUserInfo:{},showType:0,badge:0,talkData:{msgType:0,toId:0,name:"",icon:""},showFriendPopover:!1,friendActions:[{text:"删除好友",icon:"delete-o"},{text:"清空记录",icon:"brush-o"}],showGroupPopover:!1,groupActions:[{text:"退出群聊",icon:"delete-o"},{text:"清空记录",icon:"brush-o"}]});Ve(()=>{console.log("onMounted"),document.addEventListener("visibilitychange",X),le()}),qe(()=>{console.log("onUnmounted"),document.removeEventListener("visibilitychange",X),clearInterval(I.value),e.socket&&e.socket.readyState===WebSocket.OPEN&&e.socket.close(1e3,"onUnmounted")});const X=()=>{q.value=!document.hidden,q.value?(console.log("页面已变为可见"),e.socket&&e.socket.readyState!==WebSocket.OPEN&&C()):console.log("页面已变为不可见")},le=async()=>{e.selftUserInfo=H.get("userInfo"),(!e.selftUserInfo||!e.selftUserInfo.Uid)&&(H.clear(),Y(),e.socket=null,o.push("/login")),C(),I.value=setInterval(()=>{_e()},1e4);const s=`chat_${e.selftUserInfo.Uid}`,n=1,y=[{name:"groups",keyPath:"GroupId",indexes:[{name:"GroupId",keyPath:"GroupId",options:{unique:!0}}]},{name:"group_members",keyPath:"Id",indexes:[{name:"GroupId",keyPath:"GroupId"},{name:"MemberId",keyPath:"MemberId"}]},{name:"users",keyPath:"Uid",indexes:[{name:"Uid",keyPath:"Uid",options:{unique:!0}}]},{name:"message",keyPath:"Id",indexes:[{name:"CreateTime",keyPath:"CreateTime"},{name:"FromId",keyPath:"FromId"},{name:"ToId",keyPath:"ToId"},{name:"MsgType",keyPath:"MsgType"}]},{name:"apply",keyPath:"Id",indexes:[{name:"OperateTime",keyPath:"OperateTime"},{name:"Type",keyPath:"Type"}]}];e.db=await ao(s,n,y),ie(e.db,{Uid:e.selftUserInfo.Uid,Username:e.selftUserInfo.Username,Avatar:e.selftUserInfo.Avatar,IsOnline:!0})},N=()=>{e.tabActiveName=="friend"?e.title="联系人":e.tabActiveName=="group"?e.title="群聊":e.tabActiveName=="person"&&(e.title="个人中心")},$=()=>{N(),e.showType=0},ue=()=>{e.title="消息盒子",e.showType=5,e.badge=0},de=async(s,n)=>{console.log("onFriendSelect",s,n),n==0&&pe(e.selftUserInfo.Uid,e.talkData.toId),n==1&&me(e.selftUserInfo.Uid,e.talkData.toId)},pe=(s,n)=>{oe({title:"删除好友",message:`是否删除:${e.talkData.name}?`}).then(()=>{Ke({fromId:s,toId:n}).then(y=>{y.code==0?(Z("删除成功"),$()):ee(y.msg)})})},me=(s,n)=>{m.value.clearMessage(1,s,n)},fe=async()=>{if(!e.db)return;e.groupActions[0].text="退出群聊",(await M(e.db,"groups",e.talkData.toId)).OwnerUid==e.selftUserInfo.Uid&&(e.groupActions[0].text="解散群聊")},ge=async(s,n)=>{console.log("onFriendSelect",s,n),n==0&&ye(e.selftUserInfo.Uid,e.talkData.toId),n==1&&he(e.selftUserInfo.Uid,e.talkData.toId)},ye=(s,n)=>{oe({title:"退出群",message:`是否退出:${e.talkData.name}群?`}).then(()=>{Je({fromId:s,toId:n}).then(y=>{y.code==0?(Z("退出成功"),$()):ee(y.msg)})})},he=(s,n)=>{m.value.clearMessage(2,s,n)},be=()=>{f.value.clearMsg()},C=()=>{console.log("启动服务器连接"),e.socket=new WebSocket("wss://im.guiaihai.com/chat?uid="+e.selftUserInfo.Uid),e.socket.addEventListener("open",ve),e.socket.addEventListener("message",ke),e.socket.addEventListener("close",Ie),e.socket.addEventListener("error",we)},ve=s=>{console.log("WebSocket connection opened",s),v&&clearTimeout(v.value)},Ie=s=>{console.log("您已自动下线"),s.code!==1e3&&(console.error("WebSocket connection closed with code:",s.code),v.value||(v.value=setTimeout(C,5e3)))},we=s=>{console.error("WebSocket error:",s),v.value||(v.value=setTimeout(C,5e3))},_e=()=>{if(e.socket&&e.socket.readyState==1){const s={Data:"心跳"};m.value.sendMessage({FromId:e.selftUserInfo.Uid,Content:s,MsgMedia:0,MsgType:0})}},ke=s=>{const n=JSON.parse(s.data);console.log("onMessage-parent",n),O(n.MsgType,[1,2])?m.value.onMessage(s):O(n.MsgType,[3])&&(n.MsgMedia==10&&Te(),O(n.MsgMedia,[11,12])&&Ue(n),O(n.MsgMedia,[21,22,23,24])&&Pe(n),O(n.MsgMedia,[30,31,32,33,34])&&Se(n))},Te=()=>{ro({type:"danger",message:"您的账号在其他地方登录，请检查"}),H.clear(),Y(),e.socket=null,o.push("/login")},Ue=s=>{s.ToId==e.selftUserInfo.Uid&&d.value.loadUserStatus(s)},Pe=s=>{O(s.MsgMedia,[21,22,23])&&(f.value.loadUserManage(s),e.showType!=4&&e.badge++),d.value.loadUserManage(s)},Se=s=>{O(s.MsgMedia,[31,32,33])&&(f.value.loadUserManage(s),e.showType!=4&&e.badge++),h.value.loadUserManage(s)},Oe=async(s,n)=>{if(!e.db)return;const y=await M(e.db,"users",n);e.talkData={msgType:s,toId:n,name:y.Username,icon:y.Avatar},console.log(e.talkData),e.showType=1},Me=async(s,n)=>{if(!e.db)return;const y=await M(e.db,"groups",n);if(e.talkData={msgType:s,toId:n,name:y.Name,icon:y.Icon},console.log(e.talkData),(await co(e.db,"group_members","GroupId",n)).length==0){const W=await He({groupId:n});for(const F of W.data)io(e.db,n,F)}e.showType=2},De=()=>{C()},Ae=(s,n)=>{s==1&&(e.showType=3),s==2&&(e.showType=4),e.title=n},Ce=()=>{N(),e.showType=0},Ge=()=>{N(),e.showType=0},xe=()=>{e.showType=0};return(s,n)=>{const y=U("van-image"),D=U("van-icon"),W=U("van-badge"),F=U("van-popover"),Ne=U("van-nav-bar"),z=U("van-tabbar-item"),Fe=U("van-tabbar");return x(),R("div",null,[l(Ne,{border:"",fixed:"",onClickLeft:$},$e({title:b(()=>[e.showType==1||e.showType==2?E("",!0):(x(),R("div",{key:0,innerHTML:e.title},null,8,lo)),e.showType==1?(x(),R("div",uo,[l(y,{src:e.talkData.icon,width:"22",height:"22",round:""},null,8,["src"]),J("span",po,j(e.talkData.name)+"("+j(e.talkData.toId)+")",1)])):E("",!0),e.showType==2?(x(),R("div",mo,[l(y,{src:e.talkData.icon,width:"22",height:"22",round:""},null,8,["src"]),J("span",fo,j(e.talkData.name)+"("+j(e.talkData.toId)+")",1)])):E("",!0)]),_:2},[e.showType>0?{name:"left",fn:b(()=>[l(D,{name:"arrow-left",size:"18"}),go]),key:"0"}:void 0,e.showType==0?{name:"right",fn:b(()=>[l(W,{content:e.badge,"show-zero":!1},{default:b(()=>[l(D,{name:"more-o",size:"18",onClick:ue})]),_:1},8,["content"])]),key:"1"}:void 0,e.showType==1?{name:"right",fn:b(()=>[l(F,{placement:"bottom-end",show:e.showFriendPopover,"onUpdate:show":n[0]||(n[0]=G=>e.showFriendPopover=G),actions:e.friendActions,onSelect:de},{reference:b(()=>[l(D,{name:"ellipsis",size:"18"})]),_:1},8,["show","actions"])]),key:"2"}:void 0,e.showType==2?{name:"right",fn:b(()=>[l(F,{placement:"bottom-end",show:e.showGroupPopover,"onUpdate:show":n[1]||(n[1]=G=>e.showGroupPopover=G),onOpen:fe,actions:e.groupActions,onSelect:ge},{reference:b(()=>[l(D,{name:"ellipsis",size:"18"})]),_:1},8,["show","actions"])]),key:"3"}:void 0,e.showType==5?{name:"right",fn:b(()=>[l(D,{name:"brush-o",size:"18",onClick:be})]),key:"4"}:void 0]),1024),e.showType==0?(x(),We(Fe,{key:0,modelValue:e.tabActiveName,"onUpdate:modelValue":n[2]||(n[2]=G=>e.tabActiveName=G),onChange:N},{default:b(()=>[l(z,{name:"friend",icon:"chat-o"},{default:b(()=>[K("好友")]),_:1}),l(z,{name:"group",icon:"friends-o"},{default:b(()=>[K("群聊")]),_:1}),l(z,{name:"person",icon:"user-o"},{default:b(()=>[K("我的")]),_:1})]),_:1},8,["modelValue"])):E("",!0),_(l(T(r),{ref_key:"FriendRef",ref:d,onUpdateParameter:Oe,db:e.db},null,8,["db"]),[[k,e.tabActiveName=="friend"&&e.showType==0]]),_(l(T(a),{ref_key:"GroupRef",ref:h,onUpdateParameter:Me,db:e.db},null,8,["db"]),[[k,e.tabActiveName=="group"&&e.showType==0]]),_(l(T(g),{ref:"PersonRef",onUpdateParameter:Ae},null,512),[[k,e.tabActiveName=="person"&&e.showType==0]]),_(l(T(u),{ref_key:"TalkRef",ref:m,onUpdateParameter:De,socket:e.socket,db:e.db,talkData:e.talkData},null,8,["socket","db","talkData"]),[[k,e.showType==1||e.showType==2]]),_(l(T(c),{ref:"PersonUserRef",onUpdateParameter:Ce},null,512),[[k,e.showType==3]]),_(l(T(i),{ref:"PersonGroupRef",onUpdateParameter:Ge},null,512),[[k,e.showType==4]]),_(l(T(p),{ref_key:"MsgRef",ref:f,onUpdateParameter:xe,db:e.db},null,8,["db"]),[[k,e.showType==5]])])}}}),Uo=Object.freeze(Object.defineProperty({__proto__:null,default:yo},Symbol.toStringTag,{value:"Module"}));export{wo as a,ko as b,io as c,_o as d,L as e,M as f,Io as g,vo as h,O as i,To as j,Uo as k,ie as s};
